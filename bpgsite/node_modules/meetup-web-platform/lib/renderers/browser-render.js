'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _Router = require('react-router/lib/Router');

var _Router2 = _interopRequireDefault(_Router);

var _browserHistory = require('react-router/lib/browserHistory');

var _browserHistory2 = _interopRequireDefault(_browserHistory);

var _history = require('history');

var _match = require('react-router/lib/match');

var _match2 = _interopRequireDefault(_match);

var _reactRedux = require('react-redux');

var _reactRouterRedux = require('react-router-redux');

var _createStore = require('../util/createStore');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * This function creates a 'renderer', which is just a function that, when
 * called, will call ReactDOM.render() to render the application
 *
 * The routes, reducer, and app-specific middleware are provided by the
 * application - everything else is general to the meetup web platform
 *
 * @param {Object} routes the React Router routes object
 * @param {Function} reducer the root Redux reducer for the app
 * @param {Function} middleware (optional) any app-specific middleware that
 *   should be applied to the store
 *
 * @returns {Function} a function that results in a ReactDOM.render call - can
 *   use a custom root element ID or default to `'outlet'`
 */
function makeRenderer(routes, reducer) {
	var middleware = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
	var basename = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : '/';

	// the initial state is delivered in the HTML from the server as a plain object
	// containing the HTML-escaped JSON string in `window.INITIAL_STATE.escapedState`.
	// unescape the text using native `textarea.textContent` unescaping
	var escape = document.createElement('textarea');
	escape.innerHTML = window.APP_RUNTIME.escapedState;
	var unescapedStateJSON = escape.textContent;
	var initialState = JSON.parse(unescapedStateJSON);
	var createStore = (0, _createStore.getBrowserCreateStore)(routes, middleware);
	var store = createStore(reducer, initialState);
	var normalizedHistory = (0, _history.useBasename)(function () {
		return _browserHistory2.default;
	})({ basename: basename });
	var history = (0, _reactRouterRedux.syncHistoryWithStore)(normalizedHistory, store);

	return function () {
		var rootElId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'outlet';

		(0, _match2.default)({ history: history, routes: routes }, function (error, redirectLocation, renderProps) {
			_reactDom2.default.render(_react2.default.createElement(
				_reactRedux.Provider,
				{ store: store },
				_react2.default.createElement(_Router2.default, renderProps)
			), document.getElementById(rootElId));
		});
		return store;
	};
}

exports.default = makeRenderer;