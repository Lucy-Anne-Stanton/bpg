'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.getApiProxyRouteHandler = undefined;

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _boom = require('boom');

var _boom2 = _interopRequireDefault(_boom);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var handleQueryResponses = function handleQueryResponses(request, reply) {
	return function (queryResponses) {
		var response = reply(JSON.stringify({
			responses: queryResponses
		})).type('application/json');

		var payload = request.method === 'post' ? request.payload : request.query;

		var metadata = JSON.parse(payload.metadata || '{}');
		var originUrl = response.request.info.referrer;
		metadata.url = _url2.default.parse(originUrl).pathname;
		metadata.method = response.request.method;

		reply.track(response, 'api', queryResponses, metadata);
	};
};

var getApiProxyRouteHandler = exports.getApiProxyRouteHandler = function getApiProxyRouteHandler(proxyApiRequest$) {
	return function (request, reply) {
		proxyApiRequest$(request).subscribe(handleQueryResponses(request, reply), function (err) {
			reply(_boom2.default.badImplementation(err.message));
		});
	};
};