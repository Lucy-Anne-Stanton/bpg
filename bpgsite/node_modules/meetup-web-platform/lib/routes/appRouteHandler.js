'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.getAppRouteHandler = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _languageUtils = require('../util/languageUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var getAppRouteHandler = exports.getAppRouteHandler = function getAppRouteHandler(renderRequestMap) {
	return function (request, reply) {
		var supportedLangs = Object.keys(renderRequestMap);
		var requestLanguage = (0, _languageUtils.getLanguage)(request, supportedLangs);
		var redirect = (0, _languageUtils.checkLanguageRedirect)(request, reply, requestLanguage, supportedLangs);
		if (redirect) {
			return redirect;
		}
		request.log(['info'], _chalk2.default.green('Request received for ' + request.url.href + ' (' + requestLanguage + ')'));

		return renderRequestMap[requestLanguage](request).do(function () {
			return request.log(['info'], _chalk2.default.green('HTML response ready'));
		}).subscribe(function (_ref) {
			var result = _ref.result,
			    statusCode = _ref.statusCode;

			// response is sent when this function returns (`nextTick`)
			var response = reply(result).code(statusCode);

			reply.track(response, 'session');
		});
	};
};